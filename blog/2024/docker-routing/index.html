<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Oracle Cloud VM Docker No Route To Host | Andrew M. Zhang </title> <meta name="author" content="Andrew M. Zhang"> <meta name="description" content="Understanding Oracle Cloud + Docker iptable rules"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://andrewmzhang.com/blog/2024/docker-routing/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Andrew</span> M. Zhang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Oracle Cloud VM Docker No Route To Host</h1> <p class="post-meta"> Created in April 18, 2024 by Andrew M. Zhang </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>TLDR; Oracle cloud is pre-loaded with a bunch of iptable rules. You’ll have to hack at them to get Docker networking to behave in a typical fashion.</p> <h1 id="the-setup">The Setup</h1> <p>We’re using an Oracle Cloud Ubuntu VM as our host. Assume a machine with LAN address <code class="language-plaintext highlighter-rouge">10.0.0.100</code> on the <code class="language-plaintext highlighter-rouge">etho0</code> interface. We’re interested in running a Linuxserver.io Swag container as a reverse proxy on a user-defined bridge Docker network <code class="language-plaintext highlighter-rouge">lsio</code> that shows up in <code class="language-plaintext highlighter-rouge">ifconfig</code> as <code class="language-plaintext highlighter-rouge">br-xyz</code>. In the Swag container’s compose file, we port forward <code class="language-plaintext highlighter-rouge">10.0.0.100:80:80</code> and <code class="language-plaintext highlighter-rouge">10.0.0.100:443:443</code>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># This is your typical linuxserver.io swag reverse proxy setup.</span>
docker ps <span class="nt">--format</span> <span class="s2">"table </span><span class="se">\t\t\t\t</span><span class="s2">"</span>
CONTAINER ID   NAMES         IMAGE                         PORTS                                          NETWORKS
91b38a3164f2   swag          lscr.io/linuxserver/swag      10.0.0.100:80-&gt;80/tcp, 10.0.0.100:443-&gt;443/tcp lsio
</code></pre></div></div> <p>If we’ve set this up correctly, we expect to be able to reach a webpage at <code class="language-plaintext highlighter-rouge">http://10.0.0.100:80</code>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@myhost:~<span class="nv">$ </span>curl http://10.0.0.100:80
&lt;html&gt;
&lt;<span class="nb">head</span><span class="o">&gt;</span>&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div> <h1 id="the-problem">The Problem</h1> <p>If we exec into the <code class="language-plaintext highlighter-rouge">swag</code> container, we expect the following ip and port to be reachable. Unfortunately, it is not.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@myhost:~<span class="nv">$ </span>docker <span class="nb">exec</span> <span class="nt">-it</span> swag /bin/bash
root@133d975caa2f:/# curl 10.0.0.100
curl: <span class="o">(</span>7<span class="o">)</span> Failed to connect to 10.0.0.100 port 80 after 2 ms: Couldn<span class="s1">'t connect to serve
</span></code></pre></div></div> <p>The reason for this is that Oracle VMs are pre-configured with a bunch of iptable rules and with UFW disabled. I believe the reasoning for these rules is to ensure VMs are sufficiently hardened and also to manager their boot volume traffic, which is mounted via iSCSI(?). They document their odd setup <a href="https://blogs.oracle.com/developers/post/enabling-network-traffic-to-ubuntu-images-in-oracle-cloud-infrastructure" rel="external nofollow noopener" target="_blank">here</a>. Note that Oracle states that you need to explicitly open port 80 for web traffic to flow. However, we did not do this with our Ubuntu VM, so why is traffic available at <code class="language-plaintext highlighter-rouge">10.0.0.100:80</code>? This behavior is driven by how Docker port forwards work. Documented <a href="https://docs.docker.com/network/packet-filtering-firewalls/#docker-and-ufw" rel="external nofollow noopener" target="_blank">here</a>:</p> <blockquote> <p>When you publish a container’s ports using Docker, traffic to and from that container gets diverted before it goes through the ufw firewall settings. Docker routes container traffic in the nat table, which means that packets are diverted before it reaches the INPUT and OUTPUT chains that ufw uses. Packets are routed before the firewall rules can be applied, effectively ignoring your firewall configuration.</p> </blockquote> <p>If we take a look at the NAT table, we see that traffic is DNAT’d through to our docker container. When the packet hits the DNAT rule, the next chain that will be executed is the FORWARD chain where it hits out <code class="language-plaintext highlighter-rouge">swag</code> reverse proxy.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@myhost:~<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-L</span> <span class="nt">-v</span> <span class="nt">-t</span> nat
Chain PREROUTING <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
 2846  181K DOCKER     all  <span class="nt">--</span>  any    any     anywhere             anywhere             ADDRTYPE match dst-type LOCAL

Chain INPUT <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination

Chain OUTPUT <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
  382 55570 DOCKER     all  <span class="nt">--</span>  any    any     anywhere            <span class="o">!</span>localhost/8          ADDRTYPE match dst-type LOCAL

Chain POSTROUTING <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 <span class="o">[</span>... TRUNCATED ... <span class="o">]</span>

Chain DOCKER <span class="o">(</span>2 references<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in      </span>out     <span class="nb">source               </span>destination
    0     0 RETURN     all  <span class="nt">--</span>  docker0 any     anywhere             anywhere
    0     0 RETURN     all  <span class="nt">--</span>  br-xyz  any     anywhere             anywhere
    0     0 DNAT       tcp  <span class="nt">--</span>  <span class="o">!</span>br-xyz any     anywhere             myhost.mysubnet.myvcn.oraclevcn.com  tcp dpt:https to:172.20.0.2:443
   20  1200 DNAT       tcp  <span class="nt">--</span>  <span class="o">!</span>br-xyz any     anywhere             myhost.mysubnet.myvcn.oraclevcn.com  tcp dpt:http to:172.20.0.2:80
</code></pre></div></div> <p>This means you don’t actually need to open up port 80 and 443 for the reverse proxy to work. Note however that traffic originating from <code class="language-plaintext highlighter-rouge">br-xyz</code> network will not get DNAT-ed. Instead the <code class="language-plaintext highlighter-rouge">DOCKER</code> chain returns and packets end up in the <code class="language-plaintext highlighter-rouge">INPUT</code> chain. Given Oracle’s restrictive iptable settings, our packet gets rejected as it only matches the last rule.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu@myhost:~<span class="nv">$ </span><span class="nb">sudo </span>iptables <span class="nt">-L</span> <span class="nt">-v</span>
Chain INPUT <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination
 144K   20M ts-input   all  <span class="nt">--</span>  any    any     anywhere             anywhere             <span class="c"># This is because I installed tailscale w/ accept-routes</span>
69380   12M ACCEPT     all  <span class="nt">--</span>  any    any     anywhere             anywhere             state RELATED,ESTABLISHED
    2   168 ACCEPT     icmp <span class="nt">--</span>  any    any     anywhere             anywhere
31629 2614K ACCEPT     all  <span class="nt">--</span>  lo     any     anywhere             anywhere
    0     0 ACCEPT     udp  <span class="nt">--</span>  any    any     anywhere             anywhere             udp spt:ntp
  501 29392 ACCEPT     tcp  <span class="nt">--</span>  any    any     anywhere             anywhere             state NEW tcp dpt:ssh
   32  4715 REJECT     all  <span class="nt">--</span>  any    any     anywhere             anywhere             reject-with icmp-host-prohibited
</code></pre></div></div> <h1 id="the-solution">The Solution</h1> <p>For the typical reverse-proxy application, you probably won’t need to access the <code class="language-plaintext highlighter-rouge">swag</code> reverse-proxy from inside the user-defined bridge network through ip port <code class="language-plaintext highlighter-rouge">10.0.0.100:80</code>. If the reverse-proxy redirects traffic from some public ip or domain, you should be able to get the same effect by going through <code class="language-plaintext highlighter-rouge">http://mydomain.example.com:80</code>. However, sometimes my reverse proxy is hosted on a Tailscale IP and it might need to “talk to itself” through its own Tailscale IP. An example would be if you ran an uptime-kuma service that needs to check if services are up behind your reverse proxy hosted on your host’s tailscale ip.</p> <p>The solution is to allow traffic headed to port 80 and 443 in the INPUT chain.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Add the following to your iptable, where br-xyz is the network your container is hosted</span>
<span class="nt">-A</span> INPUT <span class="nt">-i</span> br-xyz <span class="nt">-d</span> 10.0.0.100 <span class="nt">-p</span> tcp <span class="nt">-m</span> state <span class="nt">--state</span> NEW <span class="nt">-m</span> multiport <span class="nt">--dports</span> 80,443 <span class="nt">-j</span> ACCEPT
</code></pre></div></div> <p>I’m not aware of any way to automatically represent the IP addr of <code class="language-plaintext highlighter-rouge">eth0</code> instead of hardcoding it like I did above. You could make the ip subnet range by replacing it with something like <code class="language-plaintext highlighter-rouge">10.0.0.100/24</code>.</p> <h2 id="ipv6">IPv6</h2> <p>Oracle doesn’t bork ip6tables, so you shouldn’t need to do anything extra to get this to work. You will need to configure docker to work with ipv6.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/custom-tld/">Custom TLD Over Tailscale</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/running-step-ca-in-docker-w-yubikey/">Running step-ca in docker w/ Yubikey</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/arduino-gps-notes/">Notes on Arduino GPS Library</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/osc-52-patch-for-vte-0425/">Mosh + Tmux + Copy Paste</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/reverse-proxies-with-custom-acme/">Reverse Proxies With Custom ACME</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Andrew M. Zhang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: April 30, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>